{% extends 'base.html' %}

{% block title %}Edit Packaging{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="d-flex align-items-center mb-4">
            <a href="{% url 'quote_detail' project.id quote.id %}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back to Quote
            </a>
            <h1 class="mb-0">Edit Packaging</h1>
        </div>

        <div class="card">
            <div class="card-body">
                <form method="post" id="editForm">
                    {% csrf_token %}

                    <!-- Packaging Category Selection -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="packaging_category" class="form-label">Packaging Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="packaging_category" name="packaging_category" required>
                                <option value="box" {% if packaging.packaging_category == 'box' %}selected{% endif %}>Box</option>
                                <option value="polybag" {% if packaging.packaging_category == 'polybag' %}selected{% endif %}>Polybag</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="packaging_type" class="form-label">Packaging Type (Optional)</label>
                            <select class="form-select" id="packaging_type" name="packaging_type">
                                <option value="">-- Custom Packaging (No Template) --</option>
                                {% for pkg_type in packaging_types %}
                                <option value="{{ pkg_type.id }}"
                                        {% if packaging.packaging_type and packaging.packaging_type.id == pkg_type.id %}selected{% endif %}
                                        data-category="{{ pkg_type.packaging_category }}"
                                        data-length="{{ pkg_type.default_length }}"
                                        data-breadth="{{ pkg_type.default_breadth }}"
                                        data-height="{{ pkg_type.default_height }}"
                                        data-polybag-length="{{ pkg_type.default_polybag_length }}"
                                        data-polybag-width="{{ pkg_type.default_polybag_width }}"
                                        data-rate="{{ pkg_type.default_rate_per_kg }}"
                                        data-polybags-per-kg="{{ pkg_type.default_polybags_per_kg }}">
                                    {{ pkg_type.name }} ({{ pkg_type.get_packaging_category_display }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Optional: Select a packaging type to auto-fill dimensions</div>
                        </div>
                    </div>

                    <!-- Box Fields -->
                    <div id="box-fields">
                        <h5 class="mb-3">Box Dimensions</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="packaging_length" class="form-label">Length (mm) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="packaging_length" name="packaging_length"
                                       step="0.00000001" value="{{ packaging.packaging_length }}">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="packaging_breadth" class="form-label">Breadth (mm) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="packaging_breadth" name="packaging_breadth"
                                       step="0.00000001" value="{{ packaging.packaging_breadth }}">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="packaging_height" class="form-label">Height (mm) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="packaging_height" name="packaging_height"
                                       step="0.00000001" value="{{ packaging.packaging_height }}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="cost" class="form-label">Cost <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="cost" name="cost"
                                       step="0.00000001" value="{{ packaging.cost }}">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="lifecycle" class="form-label">Lifecycle/Cycle <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="lifecycle" name="lifecycle"
                                       value="{{ packaging.lifecycle }}">
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="maintenance_percentage" class="form-label">Maintenance %</label>
                                <input type="number" class="form-control" id="maintenance_percentage" name="maintenance_percentage"
                                       step="0.00000001" value="{{ packaging.maintenance_percentage }}">
                            </div>
                        </div>
                    </div>

                    <!-- Polybag Fields -->
                    <div id="polybag-fields">
                        <h5 class="mb-3">Polybag Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="polybag_length" class="form-label">Polybag Length (inches) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="polybag_length" name="polybag_length"
                                       step="0.00000001" value="{{ packaging.polybag_length }}">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="polybag_width" class="form-label">Polybag Width (inches) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="polybag_width" name="polybag_width"
                                       step="0.00000001" value="{{ packaging.polybag_width }}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rate_per_kg" class="form-label">Rate per kg <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="rate_per_kg" name="rate_per_kg"
                                       step="0.00000001" value="{{ packaging.rate_per_kg }}">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="polybags_per_kg" class="form-label">Number of Polybags in 1 kg <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="polybags_per_kg" name="polybags_per_kg"
                                       step="0.00000001" value="{{ packaging.polybags_per_kg }}">
                            </div>
                        </div>
                    </div>

                    <!-- Common Field -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="parts_per_packaging" class="form-label">Parts per Packaging <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="parts_per_packaging" name="parts_per_packaging"
                                   value="{{ packaging.parts_per_packaging }}" required>
                            <div class="form-text">Number of parts in one packaging unit</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'quote_detail' project.id quote.id %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Update Packaging
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('packaging_category');
    const typeSelect = document.getElementById('packaging_type');
    const boxFields = document.getElementById('box-fields');
    const polybagFields = document.getElementById('polybag-fields');

    // Toggle fields based on category
    function toggleFields() {
        const category = categorySelect.value;
        if (category === 'box') {
            boxFields.style.display = 'block';
            polybagFields.style.display = 'none';
        } else {
            boxFields.style.display = 'none';
            polybagFields.style.display = 'block';
        }
    }

    categorySelect.addEventListener('change', toggleFields);

    // Auto-fill from packaging type
    typeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const category = selectedOption.dataset.category;
            categorySelect.value = category;
            toggleFields();

            if (category === 'box') {
                document.getElementById('packaging_length').value = selectedOption.dataset.length;
                document.getElementById('packaging_breadth').value = selectedOption.dataset.breadth;
                document.getElementById('packaging_height').value = selectedOption.dataset.height;
            } else {
                document.getElementById('polybag_length').value = selectedOption.dataset.polybagLength;
                document.getElementById('polybag_width').value = selectedOption.dataset.polybagWidth;
                document.getElementById('rate_per_kg').value = selectedOption.dataset.rate;
                document.getElementById('polybags_per_kg').value = selectedOption.dataset.polybagsPerKg;  // FIXED: removed space
            }
        }
    });

    // Initialize
    toggleFields();
});
</script>
{% endblock %}