{% extends 'base.html' %}

{% load custom_filters %}

{% block title %}{{ quote.name }} - Quote Details{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex align-items-center mb-3">
            <a href="{% url 'project_detail' project.id %}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back to Project
            </a>
            <a href="{% url 'quote_summary' project.id quote.id %}" class="btn btn-success">
                <i class="bi bi-file-text"></i> View Summary
            </a>
            <a href="{% url 'upload_complete_quote' project.id quote.id %}"
               class="btn btn-info {% if not quote.can_edit_sections %}disabled{% endif %}">
                <i class="bi bi-cloud-upload"></i> Bulk Upload All Components
            </a>
        </div>
        
        <!-- Quote Header -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2 class="mb-2">{{ quote.name }}</h2>
                        <p class="text-muted mb-2">Project: <strong>{{ project.name }}</strong></p>
                        <p class="text-muted mb-0">Client: <strong>{{ quote.client_name }}</strong></p>
                    </div>
                    <div class="text-end">
                        <!-- Version Badge -->
                        <h4 class="mb-2">
                            <span class="badge bg-info">v{{ quote.get_version }}</span>
                        </h4>

                        <!-- Status Badge -->
                        <div class="mb-2">
                            {% if quote.status == 'in_progress' %}
                                <span class="badge bg-warning">In Progress</span>
                            {% elif quote.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% elif quote.status == 'discarded' %}
                                <span class="badge bg-danger">Discarded</span>
                            {% endif %}
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress mb-2" style="width: 200px; height: 25px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ quote.get_completion_percentage }}%;"
                                 aria-valuenow="{{ quote.get_completion_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ quote.get_completion_percentage }}%
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="btn-group btn-group-sm" role="group">
                            {% if quote.status == 'in_progress' %}
                                <a href="{% url 'quote_mark_completed' project.id quote.id %}"
                                   class="btn btn-success"
                                   onclick="return confirm('Mark this quote as completed? This will change version to {{ quote.major_version|add:1 }}.0')">
                                    <i class="bi bi-check-circle"></i> Mark Completed
                                </a>
                            {% elif quote.status == 'completed' %}
                                <a href="{% url 'quote_reopen' project.id quote.id %}"
                                   class="btn btn-warning"
                                   onclick="return confirm('Reopen this quote for editing? This will change version to {{ quote.major_version|add:1 }}.0')">
                                    <i class="bi bi-unlock"></i> Reopen
                                </a>
                                <a href="{% url 'quote_discard' project.id quote.id %}"
                                   class="btn btn-danger"
                                   onclick="return confirm('Discard this quote? This action cannot be undone.')">
                                    <i class="bi bi-trash"></i> Discard
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if not quote.can_edit_sections %}
        <div class="alert alert-warning mt-3">
            <i class="bi bi-lock"></i> <strong>Note:</strong> This quote is {{ quote.get_status_display|lower }} and sections cannot be edited.
            {% if quote.status == 'completed' %}
            You can still add timeline entries. To edit sections, click "Reopen" above.
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Section Navigation -->
<ul class="nav nav-tabs mb-4" id="quoteTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="definition-tab" data-bs-toggle="tab" data-bs-target="#definition" type="button" role="tab">
            <i class="bi bi-file-text"></i> Quote Definition
            {% if quote.quote_definition_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
            <i class="bi bi-clock-history"></i> Timeline
            <span class="badge bg-secondary">{{ timeline_entries|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="raw-materials-tab" data-bs-toggle="tab" data-bs-target="#raw-materials" type="button" role="tab">
            <i class="bi bi-box"></i> Raw Materials
            {% if quote.raw_material_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="moulding-tab" data-bs-toggle="tab" data-bs-target="#moulding-machine" type="button" role="tab">
            <i class="bi bi-gear"></i> Moulding Machine
            {% if quote.moulding_machine_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="assembly-tab" data-bs-toggle="tab" data-bs-target="#assembly" type="button" role="tab">
            <i class="bi bi-tools"></i> Assembly
            {% if quote.assembly_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="packaging-tab" data-bs-toggle="tab" data-bs-target="#packaging" type="button" role="tab">
            <i class="bi bi-box-seam"></i> Packaging
            {% if quote.packaging_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transport-tab" data-bs-toggle="tab" data-bs-target="#transport" type="button" role="tab">
            <i class="bi bi-truck"></i> Transport
            {% if quote.transport_complete %}<i class="bi bi-check-circle-fill text-success ms-1"></i>{% endif %}
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="quoteTabContent">
    <!-- Quote Definition Tab -->
    <div class="tab-pane fade show active" id="definition" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Quote Definition</h5>
                <a href="{% url 'quote_definition_edit' project.id quote.id %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">{{ quote.name }}</dd>
                            
                            <dt class="col-sm-4">Customer Group:</dt>
                            <dd class="col-sm-8">{{ quote.client_group.name|default:"-" }}</dd>
                            
                            <dt class="col-sm-4">Client Name:</dt>
                            <dd class="col-sm-8">{{ quote.client_name }}</dd>
                            
                            <dt class="col-sm-4">SAP Number:</dt>
                            <dd class="col-sm-8">{{ quote.sap_number|default:"-" }}</dd>
                            
                            <dt class="col-sm-4">Part Number:</dt>
                            <dd class="col-sm-8">{{ quote.part_number }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Part Name:</dt>
                            <dd class="col-sm-8">{{ quote.part_name }}</dd>
                            
                            <dt class="col-sm-4">Amendment No:</dt>
                            <dd class="col-sm-8">{{ quote.amendment_number|default:"-" }}</dd>
                            
                            <dt class="col-sm-4">Quantity:</dt>
                            <dd class="col-sm-8">{{ quote.quantity }}</dd>
                            
                            <dt class="col-sm-4">Description:</dt>
                            <dd class="col-sm-8">{{ quote.description|default:"-" }}</dd>
                            
                            <dt class="col-sm-4">Notes:</dt>
                            <dd class="col-sm-8">{{ quote.notes|default:"-" }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Timeline Tab -->
    <div class="tab-pane fade" id="timeline" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Quote Timeline</h5>
                <a href="{% url 'timeline_add_manual' project.id quote.id %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> Add Entry
                </a>
            </div>
            <div class="card-body">
                {% if timeline_entries %}
                    <div class="timeline">
                        {% for entry in timeline_entries %}
                        <div class="timeline-entry mb-4 pb-4 border-bottom">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    {% if entry.activity_type == 'quote_created' %}
                                        <div class="badge bg-success rounded-circle p-2">
                                            <i class="bi bi-plus-circle"></i>
                                        </div>
                                    {% elif entry.activity_type == 'quote_updated' %}
                                        <div class="badge bg-primary rounded-circle p-2">
                                            <i class="bi bi-pencil"></i>
                                        </div>
                                    {% elif 'added' in entry.activity_type %}
                                        <div class="badge bg-info rounded-circle p-2">
                                            <i class="bi bi-plus"></i>
                                        </div>
                                    {% elif 'deleted' in entry.activity_type %}
                                        <div class="badge bg-danger rounded-circle p-2">
                                            <i class="bi bi-trash"></i>
                                        </div>
                                    {% elif entry.activity_type == 'section_completed' %}
                                        <div class="badge bg-success rounded-circle p-2">
                                            <i class="bi bi-check-circle"></i>
                                        </div>
                                    {% elif entry.activity_type == 'manual_entry' %}
                                        <div class="badge bg-warning rounded-circle p-2">
                                            <i class="bi bi-chat-left-text"></i>
                                        </div>
                                    {% else %}
                                        <div class="badge bg-secondary rounded-circle p-2">
                                            <i class="bi bi-circle"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-1">{{ entry.get_activity_type_display }}</h6>
                                            <small class="text-muted">
                                                <i class="bi bi-person"></i> {{ entry.user.username }}
                                                <span class="mx-2">•</span>
                                                <i class="bi bi-clock"></i> {{ entry.created_at|date:"M d, Y H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                    <p class="mb-2">{{ entry.description }}</p>
                                    {% if entry.attachment %}
                                        <div class="mt-2">
                                            <a href="{{ entry.attachment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                <i class="bi bi-paperclip"></i> View Attachment
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No timeline entries yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% load custom_filters %}

    <!-- Raw Materials Tab -->
    <div class="tab-pane fade" id="raw-materials" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Raw Materials</h5>
                <div>
                    {% if not quote.raw_material_complete and quote.can_edit_sections %}
                        <a href="{% url 'raw_material_complete' project.id quote.id %}" class="btn btn-success btn-sm me-2">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </a>
                    {% endif %}
                    <a href="{% url 'raw_material_add' project.id quote.id %}"
                       class="btn btn-primary btn-sm {% if not quote.can_edit_sections %}disabled{% endif %}">
                        <i class="bi bi-plus-circle"></i> Add Raw Material
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if raw_materials %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Material</th>
                                    <th>Grade</th>
                                    <th>Code</th>
                                    <th>Unit</th>
                                    <th>Gross Weight</th>
                                    <th>Weight (grams)</th>
                                    <th>Rate/gram</th>
                                    <th>Base Cost</th>
                                    <th>Rejection %</th>
                                    <th>Overhead %</th>
                                    <th>Maintenance %</th>
                                    <th>Profit %</th>
                                    <th>Total Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rm in raw_materials %}
                                <tr>
                                    <td>{{ rm.material_name }}</td>
                                    <td>{{ rm.grade|default:"-" }}</td>
                                    <td>{{ rm.rm_code }}</td>
                                    <td>{{ rm.unit_of_measurement }}</td>
                                    <td>{{ rm.gross_weight|smart_decimal }}</td>
                                    <td>{{ rm.gross_weight_in_grams|smart_decimal }}</td>
                                    <td>{{ rm.effective_rate|smart_decimal }}</td>
                                    <td>{{ rm.base_rm_cost|smart_decimal }}</td>
                                    <td>{{ rm.rejection_percentage|percentage_display }}%</td>
                                    <td>{{ rm.overhead_percentage|percentage_display }}%</td>
                                    <td>{{ rm.maintenance_percentage|percentage_display }}%</td>
                                    <td>{{ rm.profit_percentage|percentage_display }}%</td>
                                    <td><strong>{{ rm.rm_cost|smart_decimal }}</strong></td>
                                    <td>
                                        <a href="{% url 'raw_material_edit' project.id quote.id rm.id %}"
                                           class="btn btn-sm btn-outline-primary {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'raw_material_delete' project.id quote.id rm.id %}"
                                           class="btn btn-sm btn-outline-danger {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           onclick="return confirm('Are you sure you want to delete this raw material?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No raw materials added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Moulding Machine Tab -->
    <div class="tab-pane fade" id="moulding-machine" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Moulding Machine</h5>
                <div>
                    {% if not quote.moulding_machine_complete and quote.can_edit_sections %}
                        <a href="{% url 'moulding_machine_complete' project.id quote.id %}" class="btn btn-success btn-sm me-2">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </a>
                    {% endif %}
                    <div class="btn-group" role="group">
                        <a href="{% url 'moulding_machine_add' project.id quote.id %}"
                           class="btn btn-primary btn-sm {% if not quote.can_edit_sections %}disabled{% endif %}">
                            <i class="bi bi-plus-circle"></i> Add Manually
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if moulding_machines %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Machine Type</th>
                                    <th>Cavity</th>
                                    <th>Cycle Time (s)</th>
                                    <th>Parts/Shift</th>
                                    <th>MTC Count</th>
                                    <th>MTC Cost</th>
                                    <th>Base Cost</th>
                                    <th>Rejection %</th>
                                    <th>Overhead %</th>
                                    <th>Maintenance %</th>
                                    <th>Profit %</th>
                                    <th>Total Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mm in moulding_machines %}
                                <tr>
                                    <td>{{ mm.moulding_machine_type.name|default:"-" }}</td>
                                    <td>{{ mm.cavity }}</td>
                                    <td>{{ mm.cycle_time|smart_decimal }}</td>
                                    <td>{{ mm.number_of_parts_per_shift }}</td>
                                    <td>{{ mm.mtc_count }}</td>
                                    <td>{{ mm.mtc_cost|smart_decimal }}</td>
                                    <td>{{ mm.base_conversion_cost|smart_decimal }}</td>
                                    <td>{{ mm.rejection_percentage|percentage_display }}%</td>
                                    <td>{{ mm.overhead_percentage|percentage_display }}%</td>
                                    <td>{{ mm.maintenance_percentage|percentage_display }}%</td>
                                    <td>{{ mm.profit_percentage|percentage_display }}%</td>
                                    <td><strong>{{ mm.conversion_cost|smart_decimal }}</strong></td>
                                    <td>
                                        <a href="{% url 'moulding_machine_edit' project.id quote.id mm.id %}"
                                           class="btn btn-sm btn-outline-primary {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'moulding_machine_delete' project.id quote.id mm.id %}"
                                           class="btn btn-sm btn-outline-danger {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           onclick="return confirm('Are you sure you want to delete this moulding machine?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No moulding machines added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Assembly Tab -->
    <div class="tab-pane fade" id="assembly" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Assembly</h5>
                <div>
                    {% if not quote.assembly_complete and quote.can_edit_sections %}
                        <a href="{% url 'assembly_complete' project.id quote.id %}" class="btn btn-success btn-sm me-2">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </a>
                    {% endif %}
                    <a href="{% url 'assembly_add' project.id quote.id %}"
                       class="btn btn-primary btn-sm {% if not quote.can_edit_sections %}disabled{% endif %}">
                        <i class="bi bi-plus-circle"></i> Add Assembly
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if assemblies %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Manual Cost</th>
                                    <th>Other Cost</th>
                                    <th>Profit %</th>
                                    <th>Rejection %</th>
                                    <th>Inspection %</th>
                                    <th>Total Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assembly in assemblies %}
                                <tr>
                                    <td><strong>{{ assembly.name }}</strong></td>
                                    <td>{{ assembly.assembly_type_config.name|default:"-" }}</td>
                                    <td>{{ assembly.manual_cost|smart_decimal }}</td>
                                    <td>{{ assembly.other_cost|smart_decimal }}</td>
                                    <td>{{ assembly.profit_percentage|percentage_display }}%</td>
                                    <td>{{ assembly.rejection_percentage|percentage_display }}%</td>
                                    <td>{{ assembly.inspection_handling_percentage|percentage_display }}%</td>
                                    <td><strong>{{ assembly.total_assembly_cost|smart_decimal }}</strong></td>
                                    <td>
                                        <a href="{% url 'assembly_detail' project.id quote.id assembly.id %}"
                                           class="btn btn-sm btn-outline-info" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'assembly_edit' project.id quote.id assembly.id %}"
                                           class="btn btn-sm btn-outline-primary {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'assembly_delete' project.id quote.id assembly.id %}"
                                           class="btn btn-sm btn-outline-danger {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           onclick="return confirm('Are you sure you want to delete this assembly?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No assemblies added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Packaging Tab -->
    <div class="tab-pane fade" id="packaging" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Packaging</h5>
                <div>
                    {% if not quote.packaging_complete and quote.can_edit_sections %}
                        <a href="{% url 'packaging_complete' project.id quote.id %}" class="btn btn-success btn-sm me-2">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </a>
                    {% endif %}
                    <a href="{% url 'packaging_add' project.id quote.id %}"
                       class="btn btn-primary btn-sm {% if not quote.can_edit_sections %}disabled{% endif %}">
                        <i class="bi bi-plus-circle"></i> Add Packaging
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if packagings %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Type</th>
                                    <th>Dimensions (L×B×H)</th>
                                    <th>Polybag (L×W)</th>
                                    <th>Lifecycle</th>
                                    <th>Cost</th>
                                    <th>Parts/Polybag</th>
                                    <th>Total Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pkg in packagings %}
                                <tr>
                                    <td>{{ pkg.get_packaging_type_display }}</td>
                                    <td>{{ pkg.packaging_length|smart_decimal }} × {{ pkg.packaging_breadth|smart_decimal }} × {{ pkg.packaging_height|smart_decimal }}</td>
                                    <td>{{ pkg.polybag_length|smart_decimal }} × {{ pkg.polybag_width|smart_decimal }}</td>
                                    <td>{{ pkg.lifecycle }}</td>
                                    <td>{{ pkg.cost|smart_decimal }}</td>
                                    <td>{{ pkg.part_per_polybag }}</td>
                                    <td><strong>{{ pkg.total_packaging_cost|smart_decimal }}</strong></td>
                                    <td>
                                        <a href="{% url 'packaging_edit' project.id quote.id pkg.id %}"
                                           class="btn btn-sm btn-outline-primary {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'packaging_delete' project.id quote.id pkg.id %}"
                                           class="btn btn-sm btn-outline-danger {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           onclick="return confirm('Are you sure you want to delete this packaging?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No packaging added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% load custom_filters %}

    <!-- Transport Tab -->
    <div class="tab-pane fade" id="transport" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Transport</h5>
                <div>
                    {% if not quote.transport_complete and quote.can_edit_sections %}
                        <a href="{% url 'transport_complete' project.id quote.id %}" class="btn btn-success btn-sm me-2">
                            <i class="bi bi-check-circle"></i> Mark Complete
                        </a>
                    {% endif %}
                    <a href="{% url 'transport_add' project.id quote.id %}"
                       class="btn btn-primary btn-sm {% if not quote.can_edit_sections %}disabled{% endif %}">
                        <i class="bi bi-plus-circle"></i> Add Transport
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if transports %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Dimensions (L×B×H)</th>
                                    <th>Boxes (L×B×H)</th>
                                    <th>Total Boxes</th>
                                    <th>Parts/Box</th>
                                    <th>Parts/Trip</th>
                                    <th>Trip Cost</th>
                                    <th>Cost/Part</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transport in transports %}
                                <tr>
                                    <td>{{ transport.transport_length|smart_decimal }} × {{ transport.transport_breadth|smart_decimal }} × {{ transport.transport_height|smart_decimal }}</td>
                                    <td>{{ transport.boxes_on_length }} × {{ transport.boxes_on_breadth }} × {{ transport.boxes_on_height }}</td>
                                    <td>{{ transport.total_boxes }}</td>
                                    <td>{{ transport.parts_per_box }}</td>
                                    <td>{{ transport.total_parts_per_trip }}</td>
                                    <td>{{ transport.trip_cost|smart_decimal }}</td>
                                    <td><strong>{{ transport.trip_cost_per_part|smart_decimal }}</strong></td>
                                    <td>
                                        <a href="{% url 'transport_edit' project.id quote.id transport.id %}"
                                           class="btn btn-sm btn-outline-primary {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'transport_delete' project.id quote.id transport.id %}"
                                           class="btn btn-sm btn-outline-danger {% if not quote.can_edit_sections %}disabled{% endif %}"
                                           onclick="return confirm('Are you sure you want to delete this transport?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No transport added yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}